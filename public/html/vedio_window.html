<!-- https://gitee.com/xt-gitee/icamera/blob/master/html/vedio_window.html -->
<!-- 未测试 效果 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ICamera直播摄像头</title>
</head>
<body>
<video id="video" autoplay="autoplay"></video>
</body>
<script>
    const {ipcRenderer} = require('electron');
    const path = require('path');
    // 获得video摄像头区域
    var video = document.getElementById("video");
    var videoStream = null;
    var stop = true;
    // 页面加载完成自动执行
    window.onload = () => {
        // 获取摄像头视频
        this.getMedia();

        // 一些知识点
        // 可在渲染进程中使用electron的api
        // 使用node的api

        // 使用node模板path打印文件绝对路径
        //【C:\_developSoftKu\ideaIU-2019.1.3.win\CodeKu2\electron-egg\public\html\vedio_window.html】
        // console.log(path.resolve(__dirname, 'vedio_window.html'));

        // 说明 window 这是前端中的 window
        // console.log(window)
        // 说明 ipcRenderer 这是用于从渲染器进程到主进程的异步通信的一个 EventEmitter 的实例
        // console.log(ipcRenderer)
        // invoke返回的promise ，then里可以拿到handle返回的结果
        // send 只是 发送事件 通过 event.reply （只有主进程的event有）可以回复这次通信的另一方

        // 下面写法可用
        // ipcRenderer.invoke('controller.example.test', {this_param:123}).then(res => {
        //     console.log('res:', res)
        // })

        // 提示音
        // 创建系统通知
        // const return_msg = {
        //     type: 'main',
        //     title: '提示音',
        //     subtitle: '副标题-提示音',
        //     body: '这是通知内容-我是测试-提示音',
        //     silent: false, /*控制有无通知音-为false代表有 true代表无*/
        // }
        // 可用的
        // ipcRenderer.send('controller.example.sendNotification', return_msg)

        // 只传标题和内容
        // 可用
        // ipcRenderer.send('controller.example.showNotificationOnlyTitleANDBody', {title:'test',body:'test内容'})
    };

    // 双击停止视频并且关闭摄像头
    video.ondblclick = () => {
        // 发送关闭摄像头通知-让主线程发送系统通知
        // window.dialogAPI.quitVedio("退出直播");
        ipcRenderer.send('controller.example.showNotificationOnlyTitleANDBody', {title: '通知', body: '退出直播'})
        // this.stopMedia();
        // window.opener.postMessage("close-vedio-window");
        close_win()
    };

    async function close_win() {
        // 获取主窗口id
        ipcRenderer.invoke('controller.example.getWCid', 'main').then(id => {
            const this_mainWCid = id;
            console.log('主窗口的id', this_mainWCid)
            // ipcRenderer.sendTo(this_mainWCid, 'window2-to-window1', '窗口2 通过 sendTo 给主窗口发送消息');
        });

        // 调用官方api 关闭窗口
        const is_ok = await ipcRenderer.invoke('controller.example.removeWCid', 'window-1');
        // 此处可以正常获取 只不过当时此窗口已被关闭 无任何效果罢了
        // console.log(is_ok)
        // if(is_ok){
        //     ipcRenderer.send('controller.example.showNotificationOnlyTitleANDBody', {title: '通知', body: '关闭窗口成功'})
        // }
    }

    // 右键是暂停和开始摄像
    video.oncontextmenu = () => {
        if (stop) {
            // window.dialogAPI.resumeVedio("继续直播");
            ipcRenderer.send('controller.example.showNotificationOnlyTitleANDBody', {title: '通知', body: '继续直播'})
            this.reStartMedia();
        } else {
            // window.dialogAPI.pauseVedio("暂停直播");
            ipcRenderer.send('controller.example.showNotificationOnlyTitleANDBody', {title: '通知', body: '暂停直播'})
            this.fakeStopMedia();
        }
    };

    // 重新播放
    function reStartMedia() {
        video.play();
        this.stop = false;
    }

    // 假暂停-后台继续还有视频流
    function fakeStopMedia() {
        video.pause();
        this.stop = true;
    }

    // 结束获取视频流数据
    function stopMedia() {
        this.videoStream.getTracks()[0].stop();
        this.videoStream.getTracks()[1].stop();
    }

    // 获得视频流数据
    function getMedia() {
        var constraints = {
            video: {width: 160, height: 160},
            audio: true,
        };
        //   H5新媒体接口 navigator.mediaDevices.getUserMedia()
        var promise = navigator.mediaDevices.getUserMedia(constraints);
        promise
            .then(function (MediaStream) {
                video.srcObject = MediaStream;
                video.play();
                this.videoStream = MediaStream;
                this.stop = false;
            })
            .catch(function (PermissionDeniedError) {
                // console.log(PermissionDeniedError);
                console.log('Error => ', PermissionDeniedError.name, PermissionDeniedError.message, " 未发现设备");
                var return_msg = 'Error => ' + PermissionDeniedError.name + PermissionDeniedError.message + " 未发现设备";
                // alert(return_msg)
                ipcRenderer.send('controller.example.showNotificationOnlyTitleANDBody', {title:'通知',body:return_msg})
            });
    }
</script>
</html>

<style>
    #video {
        /* 自适应大小 */
        height: 100%;
        width: 100%;
        display: block;
        /* 设置圆形 */
        border-radius: 50%;
        /* 镜像反转 */
        transform: rotateY(180deg);
        /* 可拖拽 */
        -webkit-app-region: drag;
    }
</style>
